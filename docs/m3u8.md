## streaming upload video requirements
## generar m3u8 de videos con audio video y subtitulos
- pistas de audio (opcional)
- video (si) // audio original???
- subtitulos (opcional) //WEBVTT

- custom sub TTML || srt || ASS // ignore or save not convert // custom player
Te voy a explicar el **proceso completo de implementaci√≥n paso a paso** para procesar y generar videos para streaming con HLS (m3u8):

---

## üé¨ **PROCESO COMPLETO DE VIDEO STREAMING**

### **FASE 1: AN√ÅLISIS DEL VIDEO ORIGINAL**

1. **Extraer metadata del video**
   - Detectar resoluci√≥n original (width, height)
   - Detectar aspect ratio (16:9, 9:16, etc.)
   - Detectar duraci√≥n total
   - Detectar codec de video y audio
   - Detectar pistas de audio disponibles (idiomas, canales)
   - Detectar subt√≠tulos embebidos

2. **Validaciones iniciales**
   - Verificar que el video sea v√°lido
   - Verificar que tenga video stream
   - Identificar si tiene audio (si no, es video mudo)
   - Listar todos los tracks disponibles

---

### **FASE 2: PLANIFICACI√ìN DE VARIANTES (QUALITIES)**

3. **Generar resoluciones target**
   - Usar `ResolutionUtils.generateLowerResolutions()` basado en el original
   - Ejemplo: 1080p ‚Üí [720p, 480p, 360p, 240p]
   - Cada resoluci√≥n = 1 variante de calidad

4. **Configurar par√°metros por calidad**
   ```
   Para cada resoluci√≥n:
   - Video codec: H.264 (x264)
   - Profile: baseline/main/high seg√∫n calidad
   - Bitrate video: autom√°tico seg√∫n ResolutionUtils
   - Audio codec: AAC
   - Audio bitrate: 128k (alto), 96k (medio), 64k (bajo)
   - Framerate: mantener original o 30fps
   - Keyframe interval: 2 segundos (para seeking)
   ```

---

### **FASE 3: PROCESAMIENTO DE AUDIO**

5. **Procesar pistas de audio (si existen)**
   ```
   Para cada pista de audio:
   - Extraer audio original
   - Convertir a AAC si no lo es
   - Normalizar volumen (opcional)
   - Generar variantes por bitrate: [128k, 96k, 64k]
   - Guardar metadata: idioma, nombre, canal (stereo/mono)
   ```

6. **Si el video NO tiene audio**
   - Marcar como "video mudo"
   - Generar solo variantes de video
   - No incluir audio tracks en el m3u8

---

### **FASE 4: PROCESAMIENTO DE SUBT√çTULOS**

7. **Detectar y extraer subt√≠tulos embebidos**
   ```
   - Extraer subt√≠tulos del video (si existen)
   - Identificar formato: SRT, ASS, SSA, etc.
   ```

8. **Convertir subt√≠tulos a WEBVTT**
   ```
   - Convertir SRT ‚Üí WEBVTT (compatible HLS)
   - Convertir ASS ‚Üí WEBVTT (perder estilos complejos)
   - Ya es WEBVTT ‚Üí copiar directamente
   ```

9. **Subt√≠tulos externos (custom)**
   ```
    Si usuario sube: TTML, SRT, ASS
    NO convertir, guardar como "custom" para player personalizado
   ```

---

### **FASE 5: SEGMENTACI√ìN HLS**

10. **Generar segmentos HLS por variante**
    ```
    Para cada resoluci√≥n (720p, 480p, etc.):
    
    Comando FFmpeg conceptual:
    - Input: video original
    - Output: segmentos .ts de 6 segundos
    - Codec video: H.264
    - Codec audio: AAC (si existe)
    - Formato: HLS (m3u8 + .ts)
    - Naming: video_720p_segment_001.ts, 002.ts, etc.
    ```

11. **Generar playlist individual (.m3u8) por variante**
    ```
    Archivo: quality_720p.m3u8
    Contenido:
    - Lista de todos los segmentos .ts
    - Duraci√≥n de cada segmento
    - Tipo: VOD o EVENT
    ```

---

### **FASE 6: GENERACI√ìN DEL MASTER PLAYLIST**

12. **Crear master.m3u8 (playlist principal)**
    ```
    #EXTM3U
    #EXT-X-VERSION:3
    
    # Variante 1080p
    #EXT-X-STREAM-INF:BANDWIDTH=5000000,RESOLUTION=1920x1080,CODECS="avc1.64001f,mp4a.40.2"
    quality_1080p.m3u8
    
    # Variante 720p
    #EXT-X-STREAM-INF:BANDWIDTH=2800000,RESOLUTION=1280x720,CODECS="avc1.64001f,mp4a.40.2"
    quality_720p.m3u8
    
    # Variante 480p
    #EXT-X-STREAM-INF:BANDWIDTH=1400000,RESOLUTION=854x480,CODECS="avc1.640015,mp4a.40.2"
    quality_480p.m3u8
    ```

13. **Agregar audio alternativo (si hay m√∫ltiples pistas)**
    ```
    #EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID="audio",NAME="Espa√±ol",DEFAULT=YES,URI="audio_es.m3u8"
    #EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID="audio",NAME="English",DEFAULT=NO,URI="audio_en.m3u8"
    ```

14. **Agregar subt√≠tulos al master.m3u8**
    ```
    #EXT-X-MEDIA:TYPE=SUBTITLES,GROUP-ID="subs",NAME="Spanish",DEFAULT=YES,LANGUAGE="es",URI="subtitles_es.m3u8"
    #EXT-X-MEDIA:TYPE=SUBTITLES,GROUP-ID="subs",NAME="English",DEFAULT=NO,LANGUAGE="en",URI="subtitles_en.m3u8"
    ```

---

### **FASE 7: ESTRUCTURA DE ARCHIVOS**

15. **Organizaci√≥n en disco**
    ```
    /videos/
      /video_123/
        master.m3u8              ‚Üê Playlist principal
        
        /video/
          quality_1080p.m3u8
          quality_1080p_000.ts
          quality_1080p_001.ts
          quality_1080p_002.ts
          ...
          
          quality_720p.m3u8
          quality_720p_000.ts
          quality_720p_001.ts
          ...
        
        /audio/
          audio_es.m3u8
          audio_es_000.ts
          audio_es_001.ts
          ...
          
          audio_en.m3u8
          audio_en_000.ts
          ...
        
        /subtitles/
          subtitles_es.vtt
          subtitles_en.vtt
          subtitles_es.m3u8      ‚Üê Playlist que apunta al .vtt
          subtitles_en.m3u8
        
        /custom/
          custom_subtitle.ttml    ‚Üê Guardado sin convertir
          custom_subtitle.ass     ‚Üê Guardado sin convertir
    ```

---


### **FLUJO COMPLETO RESUMIDO**

```
1. Usuario sube video
   ‚Üì
2. Analizar metadata (resoluci√≥n, audio, subt√≠tulos)
   ‚Üì
3. Generar lista de resoluciones target con ResolutionUtils
   ‚Üì
4. Crear tarea de procesamiento
   ‚Üì
5. Para cada resoluci√≥n:
   - Transcodificar video con FFmpeg
   - Segmentar en chunks HLS (.ts)
   - Generar playlist individual (.m3u8)
   ‚Üì
6. Procesar audio (si existe)
   - Extraer pistas
   - Convertir a AAC
   - Segmentar en chunks
   ‚Üì
7. Procesar subt√≠tulos
   - Convertir a WEBVTT
   - Guardar customs sin convertir
   ‚Üì
8. Generar master.m3u8
   ‚Üì
9. Guardar metadata en DB
   ‚Üì
10. Notificar que el video est√° listo
   ‚Üì
11. Usuario puede reproducir video
```
